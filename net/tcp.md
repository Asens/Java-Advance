---
description: TCP握手和挥手方式
---

# TCP/IP 协议

### 创建连接-三次握手

建立连接的核心目标是双方都确认自己和对方有成功发送和接收数据的经验

- 第一次握手：客户端给服务器发送SYN报文
- 第二次握手：服务器收到SYN报文，返回SYN+ACK报文
- 第三次握手：客户端接收SYN+ACK报文，回应ACK报文
- 服务器接收ACK报文，建立完成

当完成三次握手时，能够保证双方都有发送和接受能力

在第一次握手时，客户端发送数据

在第二次握手，服务器接收客户端数据并发送数据，服务器确认了客户端的数据发送能力，服务器的接收能力

第三次握手，客户端接收服务器数据，并发送数据，客户端确认了客户端的数据发送能力，接收能力，服务器的发送能力，服务器的接收能力

当服务器接收最后的ACK数据，服务器确认了服务器的发送能力和客户端的接收能力

因此当完成至少三次握手，才可以保证连接建立完成

如果更加详细的描述，需要描述对应的网络状态：

- LISTENING：监听TCP端口的连接请求，服务器端打开socket
- SYN-SENT：客户端SYN_SENT状态,客户端在发送连接请求后等待匹配的状态
- SYN-RECEIVED：服务器端状态SYN_RCVD，接收客户端请求再发送后等待的状态
- ESTABLISHED：建立连接后的状态，正在传输数据

下面将更加详细的描述三次握手的过程：

在第一次握手之前，服务器处于LISTENING状态，等待请求

- 第一次握手：客户端给服务器端发送SYN报文，并指定客户端的初始化序列号 ISN(c)，客户端将状态修改为SYN_Send
- 第二次握手：服务器接收客户端的SYN报文，发送自己的报文SYN，并指定初始化序列号 ISN(s)，并将客户端发送的 ISN + 1 作为 ACK 的值，返回，并修改状态为SYN_REVD 
- 第三次握手：客户端接收服务器的SYN报文，并将服务器的ISN + 1 作为ACK返回，客户端修改状态为ESTABLISHED
- 服务器端接收ACK，修改状态为ESTABLISHED，连接创建完成

### 关闭连接-四次挥手

**关闭的状态**

- FIN_WAIT1：等待远程 TCP 的连接中断请求，或先前的连接中断请求的确认。
- FIN_WAIT2：从远程 TCP 等待连接中断请求。
- CLOSE_WAIT：等待从本地用户发来的连接中断请求。
- CLOSING：等待远程 TCP 对连接中断的确认。
- LAST_ACK：等待原来发向远程 TCP 的连接中断请求的确认。
- TIME_WAIT：等待足够的时间以确保远程 TCP 接收到连接中断请求的确认。
- CLOSED：没有任何连接状态。

**流程**

- 第一次挥手：客户端发送FIN报文，在报文中指定序列号，客户端处于FIN_WAIT1 状态
- 第二次挥手：服务器收到FIN，将客户端的序列号+1作为ACK发送，服务器端状态修改为CLOSE_WAIT 
- 第三次挥手：服务器准备断开连接，给客户端发送FIN报文，指定序列号，修改状态为LAST_ACK 
- 第四次挥手：客户端收到FIN，发送服务端发送的序列号+1作为ACK返回，修改状态为TIME_WAIT ，等待一段时间服务器收到ACK，客户端修改状态为CLOSED
- 服务器收到ACK，修改状态为CLOSED

在第四次挥手时，客户端修改状态为TIME_WAIT ，等待一段时间才CLOSED

目的是等待服务器端确认收到ACK，如果服务器没有收到，服务器会重新发送FIN报文，从第三次挥手开始重新走一次流程

如果服务器收到了，也就不会再发FIN了，客户端等待一段时间没有任何接收则修改状态为CLOSED



