---
description: 对象的创建和布局
---
# 对象的创建和内存布局

当我们new一个对象时，究竟发生了什么？

## 对象的创建

**类加载**

当虚拟机遇到new指令时，首先检查参数是否能在常量池定位到类的符号引用。以及类是否被加载，解析或是初始化过。如果没有的话，要先执行类的加载操作。

如果类加载完成，再执行对象的初始化操作。

**分配内存**

会先为对象分配内存。对象所需的内存大小尤其类决定。类加载完成时就已经确定了。然后再堆内存中找出一块足够大的内存分配给它。

- 对于提供碎片整理的垃圾收集器，未分配内存是连续的，那么只需要分配并移动指针即可
- 对于不连续的内存空间需要维护列表，找到足够大的内存空间，并在分配后更新

为了解决分配对象空间的并发问题，需要在分配内存时进行同步

- 使用cas的方式失败重试保证更新操作的原子性
- 线程在堆上预先分配本地线程缓冲区（TLAB），分配对象先在TLAB分配，不够时分配新的TLAB才进行同步操作

**初始化对象**

虚拟机将分配的内存初始化为零值。零值表示对应数据类型的零值。

这也是为什么成员变量不设置初始值可以直接使用而方法内变量不设置初始值或编译报错。

然后设置对象头的一些信息，比如对象的类，类元数据信息，哈希码，GC分布年龄，偏向锁等

执行<init>方法进行初始化

**初始化顺序**

TODO

## 对象的内存布局

对象在内存中可以分为：对象头，实例数据，对齐填充

对象头包含2部分：

- 存储自身运行时数据：哈希码，GC分代年龄，锁状态标志，线程持有锁，偏向线程ID等
- 类元数据的指针，通过这个指针来确定这个对象是哪个类的实例

