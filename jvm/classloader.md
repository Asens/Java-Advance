---
description: 虚拟机加载类以及双亲委派机制
---

# Java虚拟机加载机制

虚拟机需要加载Class文件到内存才可以运行，这边文章将描述这个过程。

## 触发

- 遇到new，getstatic，putstatic，invokestatic4条字节码指令时，会触发初始化。即用`new`创建对象时，读取或设置一个类的静态字段时，或调用一个类的静态方法时。
- 对一个类进行反射调用时
- 当初始化一个类，但是其父类未初始化时，初始化父类
- 执行一个类的main函数时，初始化该类
-  当使用JDK1.7动态语言支持时，如果一个 java.lang.invoke.MethodHandle实例最
  后的解析结果为REF_getStatic,REF_putStatic,REF_invokestatic的方法句柄 ，初始化

## 过程

类加载的过程包括加载、验证、准备、解析、初始化、使用、卸载。

其中验证、准备、解析属于连接阶段。

### 加载

在记载阶段，虚拟机需要完成

- 通过类的全限定名来获取类的二进制字节流，可以通过文件，网络，或动态生成
- 把字节流转化为方法区的运行时数据结构
- 在内存中生存这个类的Class对象

加载阶段可以定义类加载器去控制字节流的加载方式

### 验证

为了确保Class文件符合虚拟机要求，且不会危害虚拟机本身。

验证操作包括：文件格式验证、元数据验证、字节码验证、符号引用验证。

**文件格式验证**

判断Class字节流是否符合Class文件格式的规范，保证Class能够正确的解析并存储在方法区内。比如：

- 是否以0xCAFEBABE开头
- Java的主次版本号格式，以及是否在虚拟机的处理范围之内
- 常量池的常量是否有不支持的类型
- ...

**元数据验证**

对字节码进行语义分析，保证信息符合Java语言规范的要求

- 这个类是否有父类
- 这个类的父类是否继承了final类
- 如果不是实现类，是否实现了父类或接口的全部需要实现的方法
- ...

**字节码验证**

通过数据流和控制流分析，确定程序语义是正确的

- 保证操作数栈的数据类型和指令代码系列可以配合，比如不会放入一个int类型，然后以long型加载
- 保证跳转指令不会跳到方法体外面
- 保证类型转换是有效的
- ...

**符号引用验证**

在解析阶段，虚拟机将符号引用转化为直接引用，此时需要符号引用验证。主要是对类自身以外的信息进行验证。

- 根据全限定名是否能找到对应的类
- 类、字段、方法的访问性（public、private等）是否允许内当前类访问。
- ...

### 准备

为类变量(仅static)设置初始值。

```java
public static int value = 123;
```

在准备阶段会初始化为类型对应0值而不是123，除了final。

### 解析

解析阶段是将符号引用替换为直接引用的过程。

- 符号引用：用符号来描述引用的目标，能够定位到目标即可。
- 直接引用：指向目标的指针、便宜量或间接定位到目标的句柄。

虚拟机指定了特定的指令操作字节码时需要对操作符号进行解析

> 16个特定指令
>
>  anewarray、checkcast、getfield、getstatic、instanceof、invokedynamic、invokeinterface、invokespecial、invokestatic、invokevirtual、ldc、ldw、multianewarray、new、putfield、putstatic 

 解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用。

**类或接口**

如果要解析一个类A的符号引用为类或接口，如果目标不是数组，则使用类A的类加载器去加载目标类。

如果是数组，先加载数组内的类型，在生产数组对象。

**字段解析**

解析字段首先判断字段对应的类A是否被解析过，没有解析需要先解析类A。

如果类A本身包含目标字段，返回

查找类A的父类或祖先类，直到找到该字段会返回NoSuchFieldError

**类,接口方法解析**

与字段解析类似，判断指定类是否被解析过，查找类的方法，查找父类及祖先类，找到该方法或返货NoSuchMethodError

## 初始化



























